<!DOCTYPE html>
<style>
    html, body {
        margin: 0!important;
        padding: 0!important;
        overflow: hidden!important;
        width: 100%;
    }
</style>
<html>
<body>

<p id="demo"></p
<title>Video Recording | RecordRTC</title>
<h1>Simple Video Recording using RecordRTC</h1>

<br>

<button id="btn-start-recording">Start Recording</button>
<button id="btn-stop-recording" disabled>Stop Recording</button>

<hr>
<video class="vii" controls autoplay></video>
<br>
<video id="vi"controls autoplay>
  <source src="">
  Your browser does not support the video tag.
</video>
<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<script>
document.getElementById("demo").innerHTML = "Hello JavaScript!";
// Create a client instance
client = new Paho.MQTT.Client("kisradev.com", Number(1884), "/ws", "clientId1");

// set callback handlers <video controls autoplay></video>
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect,
	userName : "robotKs1",
	password : "123456789",
	useSSL: false
	});


// called when the client connects
function onConnect() {
  // Once a connection has been made, make a subscription and send a message.
  console.log("onConnect");
  client.subscribe("World");
  message = new Paho.MQTT.Message("Hello");
  message.destinationName = "World";
  client.send(message);
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
  }
}

// called when a message arrives
function onMessageArrived(message) {
  console.log("onMessageArrived:"+message.payloadString);
  //document.getElementById("demo").innerHTML = message.payloadString;
  document.getElementById("vi").src = message.payloadString;
}

// video
var video = document.querySelector('.vii');
function captureCamera(callback) {
    navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(function(camera) {
        callback(camera);
    }).catch(function(error) {
        alert('Unable to capture your camera. Please check console logs.');
        console.error(error);
    });
}
//
var startV = false;
setInterval(function(){
if(startV) {
//startV = false;
//recorder.stopRecording(stopRecordingCallback);
//
video.src = video.srcObject = null;
    video.src = URL.createObjectURL(recorder.getBlob());
	var blob = recorder.getBlob();//your blob data;
var reader = new FileReader();

reader.readAsDataURL(blob); 
reader.onloadend = function() {
    base64data = reader.result;                
    //console.log(base64data );
	message = new Paho.MQTT.Message(base64data);
  message.destinationName = "World";
  client.send(message);
  console.log("sending");

} /*else {
 //this.disabled = true;
	//startV = true;
    captureCamera(function(camera) {
        setSrcObject(camera, video);
        //video.play();
		//
		var options = {
	type: 'video',
			video: {
			width: 170,
			height: 144
			}
		};
//
        recorder = RecordRTC(camera, options);
        recorder.startRecording();
        // release camera on stopRecording
        recorder.camera = camera;
        document.getElementById('btn-stop-recording').disabled = false;
		startV = true;
    });
}//
//startV = !startV;*/
}
 }, 1000);

//
function stopRecordingCallback() {
    //video.src = video.srcObject = null;
    //video.src = URL.createObjectURL(recorder.getBlob());
    //video.play();
    //recorder.camera.stop();
    //recorder.destroy();
    //recorder = null;
	
 //}
}
var recorder; // globally accessible
document.getElementById('btn-start-recording').onclick = function() {
    //this.disabled = true;
	startV = true;
    captureCamera(function(camera) {
        setSrcObject(camera, video);
        video.play();
		//
		var options = {
   type: 'video',
   video: {
      width: 170,
      height: 144
   }
};
//
        recorder = RecordRTC(camera, options);
        recorder.startRecording();
        // release camera on stopRecording
        recorder.camera = camera;
        document.getElementById('btn-stop-recording').disabled = false;
    });
};
document.getElementById('btn-stop-recording').onclick = function() {
    //this.disabled = true;
    recorder.stopRecording(stopRecordingCallback);
};

</script>

<noscript>Sorry, your browser does not support JavaScript!</noscript>

<p>A browser without support for JavaScript will show the text written inside the noscript element.</p>
 
</body>
</html>
